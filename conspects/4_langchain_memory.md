üìñ –ü–∞–º—è—Ç—å –ø–æ–∑–≤–æ–ª—è–µ—Ç LLM –ø–æ–º–Ω–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é LLM —è–≤–ª—è–µ—Ç—Å—è `stateless`, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–∞–∂–¥–æ–≥–æ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç –¥—Ä—É–≥–∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π. –ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ, –∫–æ–≥–¥–∞ –º—ã –≤–≤–æ–¥–∏–º –∑–∞–ø—Ä–æ—Å—ã –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ ChatGPT, –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞–º—è—Ç—å - —Ç.–µ. –º–æ–¥–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞–º, –∏—Å—Ö–æ–¥—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤—Å–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞. 

üß† `InMemoryChatMessageHistory` - —Ö—Ä–∞–Ω–∏–º –∏—Å—Ç–æ—Ä–∏—é –≤ –ø–∞–º—è—Ç–∏

üìñ –û–¥–∏–Ω –∏–∑ —Å–ø–æ—Å–æ–±–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –≤ `LangChain` - —ç—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ—Å—Ç–∞ –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ (`InMemoryChatMessageHistory`), –ø–æ–¥—Ö–æ–¥–∏—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –∫–æ–≥–¥–∞ –≤—Å—ë –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∑–∞ –æ–¥–∏–Ω —Å–µ–∞–Ω—Å (–≤ –æ–¥–Ω–æ–º –¥–∏–∞–ª–æ–≥–µ), –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –≤—Å—ë –æ–±–Ω—É–ª–∏—Ç—Å—è.

–ß—Ç–æ–±—ã –ø—Ä–∏–∫—Ä—É—Ç–∏—Ç—å –∫ –ª—é–±–æ–º—É `Runnable` –æ–±—ä–µ–∫—Ç—É –ø–∞–º—è—Ç—å, –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±—ë—Ä—Ç–∫–∞ `RunnableWithMessageHistory`. –û–±—ä–µ–∫—Ç `Runnable` - –Ω–∞–∏–±–æ–ª–µ–µ –±–ª–∏–∑–æ–∫ –ø–æ —Å–º—ã—Å–ª—É –∫ "–∑–∞–ø—É—Å–∫–∞–µ–º—ã–π –æ–±—ä–µ–∫—Ç".

–ß—Ç–æ–±—ã –≤ –ø–∞–º—è—Ç–∏ –Ω–µ –ø—É—Ç–∞–ª–∏—Å—å –¥–∏–∞–ª–æ–≥–∏ –æ—Ç —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ø–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º —Ç–µ–º–∞–º –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ  –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è `sessi–æn ID`. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª—é—á–µ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä –µ—â—ë `user ID`, —á—Ç–æ–±—ã –æ—Ç–µ–ª—å–Ω–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ –Ω–∞ —Ä–∞–∑–Ω—ã–µ —Ç–µ–º—ã —Å –æ–¥–Ω–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (–≤—Å–ø–æ–º–Ω–∏—Ç–µ –∫–∞–∫ —Å–æ–∑–¥–∞—ë—Ç–µ –Ω–æ–≤—ã–π —á–∞—Ç —Å ChatGPT).


```python
import os
from dotenv import load_dotenv
from langchain_openai import ChatOpenAI

load_dotenv()
api_key: str = os.getenv("api_key", "")
base_url: str = os.getenv("base_url", "")

llm = ChatOpenAI(
    model="gpt-5-nano-2025-08-07",
    api_key=api_key,
    base_url=base_url,
)

# –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –Ω–∞—à–µ–≥–æ Runnable, —á—Ç–æ–±—ã —É–∫–∞–∑–∞—Ç—å –µ–º—É session_id –ø—Ä–∏ –≤—ã–∑–æ–≤–µ
config = {"configurable": {"session_id": "1"}}

llm_with_history = RunnableWithMessageHistory(
    llm,
    get_session_history
)

# –∫ –≤—ã–∑–æ–≤—É –¥–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä config
llm_with_history.invoke("–ü—Ä–∏–≤–µ—Ç, ChatGPT! –ú–µ–Ω—è –∑–æ–≤—É—Ç –ò–≤–∞–Ω. –ö–∞–∫ –¥–µ–ª–∞?", config=config).content
print(store['1'])
llm_with_history.invoke("–°–º–æ–∂–µ—à—å –ø–æ–º–æ—á—å –º–Ω–µ –≤ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ –∫–æ–¥–∞ –Ω–∞ Python?", config=config).content
print(store['1'])
```

<div class="alert alert-success" style="background-color:#e6e6; padding:13px; border-width:3px; border-color:#efe6ef; border-style:solid; border-radius:6px">
    
**–í–∏–¥–Ω–æ, —á—Ç–æ –±–ª–∞–≥–æ–¥–∞—Ä—è –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –º–æ–¥–µ–ª—å –∑–Ω–∞–ª–∞, —á—Ç–æ –Ω–∞–º –Ω—É–∂–µ–Ω –æ—Ç–≤–µ—Ç –∏–º–µ–Ω–Ω–æ c —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–æ–º —è–∑—ã–∫–∞ Python.**

–í `InMemoryChatMessageHistory` —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–∞—Ä–∞–º–∏ `HumanMessage` - `AIMessage`.  </div>

```python
get_session_history('1').clear()
```
<div style="background-color:#e6e6; padding:13px; border-width:3px; border-color:#efe6ef; border-style:solid; border-radius:6px">

–ú–æ–¥–µ–ª—å –Ω–µ —Å–º–æ–≥–ª–∞ –æ—Ç–≤–µ—Ç–∏—Ç—å, —Ç–∞–∫ –∫–∞–∫ –æ—á–∏—Å—Ç–∏–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –¥–∏–∞–ª–æ–≥. 

**–ö–æ–Ω—Ç–µ–∫—Å—Ç (–∏—Å—Ç–æ—Ä–∏—é) –º–æ–∂–Ω–æ –∑–∞–¥–∞–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é, –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å –∏–∑ —Ñ–∞–π–ª–∞ –∏–ª–∏ –ë–î.** </div>


```python
from langchain_core.messages import HumanMessage, AIMessage
get_session_history('1').clear()

# –î–æ–ø—É—Å—Ç–∏–º —ç—Ç–∏ –ø—Ä–∏–º–µ—Ä—ã –º—ã –≤–∑—è–ª–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
user_message = HumanMessage(content="–ü—Ä–∏–≤–µ—Ç –º–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ—Ä–æ–Ω?")
ai_message = AIMessage(content="–ü—Ä–∏–≤–µ—Ç, –ê–ª–µ—Ä–æ–Ω. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?")
# –∑–∞–≥—Ä—É–∑–∏–º –¥–∏–∞–ª–æ–≥ –≤ –ø–∞–º—è—Ç—å –º–µ—Ç–æ–¥–æ–º add_messages, –ø—Ä–∏–Ω–∏–º–∞—é—â–∏–º —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
get_session_history('1').add_messages([user_message, ai_message])

store
```

<div class="alert alert-info" style="padding:10px; border-width:3px; border-color:#efe6ef; border-style:solid; border-radius:6px">
    
üìñ **–î–ª—è –ø–æ–¥–≥—Ä—É–∑–∫–∏ –≤ –ø–∞–º—è—Ç—å —Ç–∞–∫ –∂–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã:**
* `add_message` - –¥–æ–±–∞–≤–ª—è–µ—Ç –ª—é–±–æ–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è
* `add_ai_message` - –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–∏–ø–∞ `AIMessage`
* `add_user_message` - –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–∏–ø–∞ `HumanMessage`
* `aadd_messages` - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π </div>


# <center id="d3"> `ChatPromptTemplate` + –ø–∞–º—è—Ç—å = —Ü–µ–ø–æ—á–∫–∞ –≤—Å—ë –ø–æ–º–Ω–∏—Ç üß† </center>

–î–æ —ç—Ç–æ–≥–æ –º—ã –≤—ã–∑—ã–≤–∞–ª–∏ —Ç–æ–ª—å–∫–æ LLM, —Ç–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä—ë–º—Å—è –∫–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –ø–∞–º—è—Ç—å –∫ –ø—Ä–æ—Å—Ç–æ–π —Ü–µ–ø–æ—á–∫–µ, –≤ –∫–æ—Ç–æ—Ä–æ–π –µ—Å—Ç—å —à–∞–±–ª–æ–Ω –ø—Ä–æ–º–ø—Ç–∞.

```python
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder

# –°–æ–∑–¥–∞–¥–∏–º —à–∞–±–ª–æ–Ω –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
# –û—Å—Ç–∞–≤–∏–º –≤ —à–∞–±–ª–æ–Ω–µ "–∑–∞–≥–ª—É—à–∫—É" - MessagesPlaceholder, –≤ –∫–æ—Ç–æ—Ä—É—é –±—É–¥–µ—Ç –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å—Å—è –∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
prompt = ChatPromptTemplate.from_messages([
    ("system", "–¢—ã –ø–æ–ª–µ–∑–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –æ—Ç–ª–∏—á–Ω–æ —Ä–∞–∑–±–∏—Ä–∞—é—â–∏–π—Å—è –≤ {topic}"),
    MessagesPlaceholder(variable_name="chat_history"),
    ("human", "{question}"),
])


# —Å–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ—Å—Ç—É—é —Ü–µ–ø–æ—á–∫—É
chain = prompt | llm

# –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
chain_with_history = RunnableWithMessageHistory(
    chain,
    get_session_history, 
    input_messages_key="question",  # —É–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–æ–π –∑–∞–ø—Ä–æ—Å–∞
    history_messages_key="chat_history", # –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑ —à–∞–±–ª–æ–Ω–∞
)

chain_with_history.invoke(
    {"topic": "–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞", "question": "–ß–µ–º—É —Ä–∞–≤–µ–Ω —Å–∏–Ω—É—Å 30?"},
    config={"configurable": {"session_id": "2"}}).content

chain_with_history.invoke(
    {"topic": "–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞", "question": "–ê —á–µ–º—É —Ä–∞–≤–µ–Ω –∫–æ—Å–∏–Ω—É—Å?"},
    config={"configurable": {"session_id": "2"}}).content
```

<div class="alert alert-success" style="background-color:#e6e6; padding:13px; border-width:3px; border-color:#efe6ef; border-style:solid; border-radius:6px">
    
–ò–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–æ–¥–µ–ª—å –ø–æ–Ω—è–ª–∞, —á—Ç–æ –º—ã —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ –∫–æ—Å–∏–Ω—É—Å —É–≥–ª–∞ 30 –≥—Ä–∞–¥—É—Å–æ–≤.

üëÄ –ü–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ `store` - —Ç–µ–ø–µ—Ä—å –ø–æ 2 —Ä–∞–∑–Ω—ã–º –∫–ª—é—á–∞–º —Ö—Ä–∞–Ω—è—Ç—Å—è –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤.</div>


<div class="alert alert-info" style="padding:10px; border-width:3px; border-color:#efe6ef; border-style:solid; border-radius:6px">
    
üìñ **–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ `InMemoryChatMessageHistory`:**
* –ò—Å—Ç–æ—Ä–∏—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏. –ü—Ä–∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–∞—Ö –∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–∞–º—è—Ç—å –º–æ–∂–µ—Ç –∑–∞–∫–æ–Ω—á–∏—Ç—å—Å—è
* –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –∏–ª–∏ —Å–±–æ–µ —Å–µ—Ä–≤–µ—Ä–∞ - –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è –∏—Å—á–µ–∑–Ω–µ—Ç
* –ß–µ–º –¥–ª–∏–Ω–Ω–µ–µ –∏—Å—Ç–æ—Ä–∏—è, —Ç–µ–º –±–æ–ª—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏–¥–µ—Ç—Å—è –ø–æ–¥–∞–≤–∞—Ç—å –Ω–∞ –≤—Ö–æ–¥ –º–æ–¥–µ–ª–∏
* –í —Å–ª—É—á–∞–µ –ø–ª–∞—Ç–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π, —ç—Ç–æ –±—É–¥–µ—Ç –Ω–∞–∫–ª–∞–¥–Ω–æ –ø–æ —Ñ–∏–Ω–∞–Ω—Å–∞–º
* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –æ–∫–Ω–æ –º–æ–¥–µ–ª–µ–π —Ç–æ–∂–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ç–æ–∫–µ–Ω–æ–≤ </div>

<div class="alert alert-info" style="padding:10px; border-width:3px; border-color:#efe6ef; border-style:solid; border-radius:6px">

–ü–æ—ç—Ç–æ–º—É —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –Ω–µ –≤—Å—ë –ø–æ–¥—Ä—è–¥, –∞ –≤—ã–¥–µ–ª—è—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –∏–∑ –¥–∏–∞–ª–æ–≥–∞ –∏–ª–∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —Å—É–º–º–∞—Ä–∏–∑–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π.</div>

<div style="padding:13px; border-width:3px; border-color:#efe6ef; border-style:solid; border-radius:6px">

–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω —Ä–µ—à–µ–Ω–∏–π –º–æ–∂–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –±–æ–ª–µ–µ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –≤ `Langchain`, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–µ–ª–∏–∑–æ–≤–∞–Ω—ã:
* `FileChatMessageHistory` - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ñ–∞–π–ª.
* `RedisChatMessageHistory` - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Redis.
* `SQLChatMessageHistory` - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö SQL.
* `MongoDBChatMessageHistory` - –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Mongo
* –∏ –º–Ω–æ–≥–∏–µ [–¥—Ä—É–≥–∏–µ](https://python.langchain.com/api_reference/community/chat_message_histories.html)